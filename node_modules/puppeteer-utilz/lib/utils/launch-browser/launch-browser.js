"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.launchBrowser = void 0;
var _regeneratorRuntime = _interopRequireDefault(require("regenerator-runtime"));
var _ = require("..");
var _internals = require("../../internals");
function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
    try {
        var info = gen[key](arg);
        var value = info.value;
    } catch (error) {
        reject(error);
        return;
    }
    if (info.done) {
        resolve(value);
    } else {
        Promise.resolve(value).then(_next, _throw);
    }
}
function _asyncToGenerator(fn) {
    return function() {
        var self = this, args = arguments;
        return new Promise(function(resolve, reject) {
            var gen = fn.apply(self, args);
            function _next(value) {
                asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value);
            }
            function _throw(err) {
                asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err);
            }
            _next(undefined);
        });
    };
}
function _defineProperty(obj, key, value) {
    if (key in obj) {
        Object.defineProperty(obj, key, {
            value: value,
            enumerable: true,
            configurable: true,
            writable: true
        });
    } else {
        obj[key] = value;
    }
    return obj;
}
function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
function _objectSpread(target) {
    for(var i = 1; i < arguments.length; i++){
        var source = arguments[i] != null ? arguments[i] : {
        };
        var ownKeys = Object.keys(source);
        if (typeof Object.getOwnPropertySymbols === "function") {
            ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym) {
                return Object.getOwnPropertyDescriptor(source, sym).enumerable;
            }));
        }
        ownKeys.forEach(function(key) {
            _defineProperty(target, key, source[key]);
        });
    }
    return target;
}
function _objectWithoutProperties(source, excluded) {
    if (source == null) return {
    };
    var target = _objectWithoutPropertiesLoose(source, excluded);
    var key, i;
    if (Object.getOwnPropertySymbols) {
        var sourceSymbolKeys = Object.getOwnPropertySymbols(source);
        for(i = 0; i < sourceSymbolKeys.length; i++){
            key = sourceSymbolKeys[i];
            if (excluded.indexOf(key) >= 0) continue;
            if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue;
            target[key] = source[key];
        }
    }
    return target;
}
function _objectWithoutPropertiesLoose(source, excluded) {
    if (source == null) return {
    };
    var target = {
    };
    var sourceKeys = Object.keys(source);
    var key, i;
    for(i = 0; i < sourceKeys.length; i++){
        key = sourceKeys[i];
        if (excluded.indexOf(key) >= 0) continue;
        target[key] = source[key];
    }
    return target;
}
var launchBrowser = _asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(startUrl, param) {
    var config = param === void 0 ? {
    } : param;
    var loadConfig, method, rest, browser, page, _loadConfig, puppeteer, firstPage;
    return _regeneratorRuntime.default.wrap(function _callee$(_ctx) {
        while(1)switch(_ctx.prev = _ctx.next){
            case 0:
                var ref, ref1;
                ref = config, loadConfig = ref.loadConfig, ref1 = ref.method, method = ref1 === void 0 ? "launch" : ref1, ref, rest = _objectWithoutProperties(config, ["loadConfig", "method"]);
                ;
                ;
                _loadConfig = _objectSpread({
                    waitUntil: "networkidle2",
                    timeout: (0, _internals).time("30 seconds")
                }, loadConfig);
                _ctx.prev = 4;
                _internals.logger.debug("Launching browser");
                _ctx.next = 8;
                return (0, _internals).getPuppeteer();
            case 8:
                puppeteer = _ctx.sent;
                _ctx.next = 11;
                return puppeteer[method](rest);
            case 11:
                browser = _ctx.sent;
                _ctx.next = 14;
                return browser.pages();
            case 14:
                var ref2;
                ref2 = _ctx.sent, firstPage = ref2[0], ref2;
                page = firstPage;
                _ctx.next = 22;
                break;
            case 18:
                _ctx.prev = 18;
                _ctx.t0 = _ctx["catch"](4);
                console.error(_ctx.t0);
                return _ctx.abrupt("return", null);
            case 22:
                if (!(config && config.dimensions)) {
                    _ctx.next = 25;
                    break;
                }
                _ctx.next = 25;
                return page.setViewport(config.dimensions).catch(_.noop);
            case 25:
                _internals.logger.debug("Heading to ".concat(startUrl));
                _ctx.next = 28;
                return page.goto(startUrl, _loadConfig).catch(_.noop);
            case 28:
                _ctx.next = 30;
                return (0, _).waitForNavigation(page, _loadConfig).catch(_.noop);
            case 30:
                _internals.logger.debug("".concat(startUrl, " is ready"));
                return _ctx.abrupt("return", {
                    browser: browser,
                    page: page
                });
            case 32:
            case "end":
                return _ctx.stop();
        }
    }, _callee, null, [
        [
            4,
            18
        ]
    ]);
}));
exports.launchBrowser = launchBrowser;
